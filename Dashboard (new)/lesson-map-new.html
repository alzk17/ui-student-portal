<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lambda</title>

    <!-- Vendor CSS -->
    <link rel="stylesheet" href="https://lambda.in.th/assets_dashboard/css/bootstrap.css?v=1754330467" />
    <link rel="stylesheet" href="https://cdn.lineicons.com/5.0/lineicons.css" />
    <link rel="stylesheet" href="https://lambda.in.th/assets_dashboard/css/icofont.css?v=1754330467" />
    <link rel="stylesheet" href="https://lambda.in.th/assets_dashboard/css/styles.css?v=1754330467" />
    <link rel="stylesheet" href="https://lambda.in.th/assets_dashboard/css/font-icon.css?v=1754330467">
    <link rel="stylesheet" href="https://lambda.in.th/assets_dashboard/css/slick.min.css?v=1754330467">
    <link rel="stylesheet" href="https://lambda.in.th/assets_dashboard/css/slick-custom.css?v=1754330467">
    <link rel="stylesheet" href="https://lambda.in.th/assets/cusmike/sweet2/sweetalert2.min.css?v=1754330467">
    <link rel="stylesheet" href="https://lambda.in.th/assets/cusmike/toastr/toastr.min.css?v=1754330467">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/buttons.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/sidebar.css?v=123123123">
    <link rel="stylesheet" href="css/tooltip.css">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/tooltip-widgets.css">
    <link rel="stylesheet" href="css/lesson-map.css">
</head>
<body>
    <div class="wrapper">
        <aside id="sidebar" class="expand">
            <!-- Sidebar Logo -->
            <div class="logo-sidebar">
                <div class="sidebar-logo">
                    <a href="https://lambda.in.th/dashboard-child">
                        <img src="https://lambda.in.th/assets_dashboard/img/logos/logo-big.svg" class="logo-expanded" alt="Logo">
                        <img src="https://lambda.in.th/assets_dashboard/img/logos/logo-small.svg" class="logo-collapsed" alt="Small Logo">
                    </a>
                </div>
            </div>

            <!-- Sidebar Navigation -->
            <ul class="sidebar-nav">
                <li class="sidebar-item">
                    <a href="https://lambda.in.th/dashboard-child" class="sidebar-link">
                        <img src="https://lambda.in.th/assets_dashboard/img/icons/home.svg" class="img-fluid img-icon" alt="Home"> 
                        <span>Home</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="https://lambda.in.th/dashboard-child/journey" class="sidebar-link">
                        <img src="https://lambda.in.th/assets_dashboard/img/icons/hat.svg" class="img-fluid img-icon" alt="Learn">
                        <span>Learn</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="https://lambda.in.th/dashboard-child/set-work" class="sidebar-link">
                        <img src="https://lambda.in.th/assets_dashboard/img/icons/target.svg" class="img-fluid img-icon" alt="Set Tasks"> 
                        <span>Set Tasks</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="https://lambda.in.th/dashboard-child/review" class="sidebar-link">
                        <img src="https://lambda.in.th/assets_dashboard/img/icons/magnifier.svg" class="img-fluid img-icon" alt="Review">
                        <span>Review</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="https://lambda.in.th/dashboard-child/worksheet" class="sidebar-link">
                        <img src="https://lambda.in.th/assets_dashboard/img/icons/binders.svg" class="img-fluid img-icon" alt="Resources">
                        <span>Resources</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="https://lambda.in.th/dashboard-child/hangouts" class="sidebar-link">
                        <img src="https://lambda.in.th/assets_dashboard/img/icons/shop.svg" class="img-fluid img-icon-step2" alt="Shop">
                        <span>Shop</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="https://lambda.in.th/dashboard-child/profile" class="sidebar-link">
                        <img src="https://lambda.in.th/assets_dashboard/img/icons/id.svg" class="img-fluid img-icon-step2" alt="Profile">
                        <span>Profile</span>
                    </a>
                </li>
            </ul>

            <!-- Sidebar Footer -->
            <div class="sidebar-footer">
                <div class="dropdown">
                    <a class="dropdown-toggle sidebar-link" href="javascript:void(0)" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <img src="https://lambda.in.th/assets_dashboard/img/icons/more-test.svg" class="img-fluid img-icon" alt="More"> 
                        <span>More</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="https://lambda.in.th/dashboard-child/settings"><span>Settings</span></a></li>
                        <li><a class="dropdown-item" href="https://lambda.in.th/dashboard-child/help"><span>Help</span></a></li>
                        <li><a class="dropdown-item" href="#" onclick="openProblemReportModal();"><span>Report a problem</span></a></li>
                        <li><div class="dropdown-divider"></div></li>
                        <li><a class="dropdown-item" href="https://lambda.in.th/dashboard-parent"><span>Switch to parent account</span></a></li>
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="logoutChild();"><span>Log out</span></a></li>
                    </ul>
                </div>
            </div>
        </aside>

        <div class="main">
            <header class="border-header-page">
                <div class="container-custom">
                    <div class="box-headerpage">
                        <div class="search-bar-wrapper">
                            <div class="profile-mini" data-tooltip-id="profile-tooltip">
                                <div class="box-image">
                                    <img src="https://lambda.in.th/uploads/child/child27012025-141619.jpeg" class="img-fluid" alt="Profile">
                                </div>
                                <div class="profile-name">Kwannpat</div>

                                <div class="portal-tooltip portal-tooltip--profile" id="profile-tooltip" style="display: none;">
                                    <div class="tooltip-profile-header">
                                        <img src="https://lambda.in.th/uploads/child/child27012025-141619.jpeg" alt="Profile" class="tooltip-profile-image">
                                        <div class="tooltip-profile-info">
                                            <p class="tooltip-title">Kwannpat Kotiram</p>
                                            <div class="tooltip-info-pair">
                                                <span class="tooltip-label">Age:</span>
                                                <span class="tooltip-value">-</span>
                                            </div>
                                            <div class="tooltip-info-pair">
                                                <span class="tooltip-label">Plan:</span>
                                                <span class="tooltip-value">-</span>
                                            </div>
                                            <p class="tooltip-value">You have 0 days remaining.</p>
                                        </div>
                                    </div>
                                    <div class="tooltip-cta-wrapper">
                                        <a href="/top-up" class="portal-btn portal-btn--primary" style="width: 100%;">Top up now</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="right-icons-wrapper">
                            <div class="box-streak">
                                <div><img src="https://lambda.in.th/assets_dashboard/img/icons/bolt.svg" alt="Streak Icon"></div>
                                <div class="streak-counter">233</div>
                            </div>

                            <div class="box-gem" data-tooltip-id="gem-tooltip">
                                <div>
                                    <img src="https://lambda.in.th/assets_dashboard/img/icons/gem.svg" class="img-fluid" alt="Gem Icon">
                                </div>
                                <div class="gem-counter">90</div>

                                <div class="portal-tooltip portal-tooltip--gem" id="gem-tooltip" style="display: none;">
                                    <div class="tooltip-gem-content">
                                        <div class="tooltip-gem-icon">
                                            <img src="https://lambda.in.th/assets_dashboard/img/icons/gem.svg" alt="Gem Icon">
                                        </div>
                                        <div class="tooltip-gem-text">
                                            <p class="gem-count"><span style="color: #375ce3">90</span> Gems</p>
                                            <p class="tooltip-info" style="margin: 0;">
                                                Use them to buy streak shields or items at the
                                                <a href="/dashboard-child/hangouts" class="tooltip-link">Shop</a>.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="box-notification has-unread" data-tooltip-id="notification-tooltip">
                                <img src="https://lambda.in.th/assets_dashboard/img/icons/bell.svg" alt="Notification Icon">
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="container-custom">
                <div class="portal-layout">
                    <div class="portal-main portal-main--fullwidth">
                        <!-- Section 1: Course Overview -->
                        <section class="portal-section course-overview">
                            <!-- Course Title & Level Badge -->
                            <div class="course-header">
                                <h1>Foundational Maths</h1>
                                <span class="course-badge">Primary 1–3</span>
                            </div>

                            <div class="course-btn-row" style="display: flex; gap: 16px; margin: 16px 0 16px 0;">
                                <button class="portal-btn portal-btn--primary">
                                    Start learning
                                </button>
                                <a href="/dashboard-child/set-work" class="portal-btn portal-btn--green" style="text-decoration: none;">
                                    Set custom practice
                                </a>
                            </div>

                            <!-- Description -->
                            <div class="course-summary">
                                <p>Build a strong foundation in maths through bite-sized, interactive lessons. Designed to grow with each learner, step by step.</p>
                            </div>

                            <!-- Progress Bar -->
                            <div class="course-progress">
                                <div class="progress-header">
                                    <span class="progress-label">Course Progress</span>
                                    <span class="progress-percent">32% Complete</span>
                                </div>
                                <div class="progress-bar-bg">
                                    <div class="progress-bar-fill" style="width: 32%"></div>
                                </div>
                            </div>

                        </section>

                        <!-- Section 2: Syllabus/Lesson Map -->
                        <section class="portal-section syllabus-map">
                            <!-- For each topic:
                            - Divider/label for difficulty/year
                            - List of lessons/nodes/cards
                            -->
                        </section>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vendor Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://lambda.in.th/assets_dashboard/js/bootstrap.min.js?v=1754330467"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://lambda.in.th/assets_dashboard/js/slick.min.js?v=1754330467"></script>
    <script src="https://lambda.in.th/assets_dashboard/js/main.js?v=1754330467"></script>
    <script src="https://lambda.in.th/assets/cusmike/sweet2/sweetalert2.min.js?v=1754330467"></script>
    <script src="https://lambda.in.th/assets/cusmike/toastr/toastr.min.js?v=1754330467"></script>
    <script src="https://lambda.in.th/assets_dashboard/js/tooltip.js?v=1754330467"></script>
    <script src="https://lambda.in.th/assets_dashboard/js/viewport-fix.js?v=1754330467"></script>

    <!-- Sidebar and UI Interactions -->
    <script>
        $(document).ready(function () {
            // Handle sidebar expansion based on screen size
            const handleSidebar = () => {
                const sidebar = $("#sidebar");
                if (!sidebar.length) return;

                if (window.matchMedia("(max-width: 1024px)").matches) {
                    sidebar.removeClass("expand");
                } else {
                    sidebar.addClass("expand");
                }
            };

            handleSidebar();
            $(window).resize(handleSidebar);

            // Handle journey box clicks
            const boxJourneys = document.querySelectorAll(".box-item-journey");
            boxJourneys.forEach(box => {
                box.addEventListener("click", () => {
                    boxJourneys.forEach(b => b.classList.remove("active-journey"));
                    box.classList.add("active-journey");
                });
            });

            // Handle content choice clicks
            const boxContentChoices = document.querySelectorAll(".box-content-choice");
            boxContentChoices.forEach(box => {
                box.addEventListener("click", () => {
                    boxContentChoices.forEach(b => b.classList.remove("answer-success"));
                    box.classList.add("answer-success");
                });
            });

            // Handle filter review box clicks
            const boxContentFilterReview = document.querySelectorAll(".box-border");
            boxContentFilterReview.forEach(box => {
                box.addEventListener("click", () => {
                    boxContentFilterReview.forEach(b => b.classList.remove("active-box-filter-review"));
                    box.classList.add("active-box-filter-review");
                });
            });
        });

        // Logout function
        function logoutChild() {
            const parentId = localStorage.getItem("parent_id");
            if (parentId != 0) {
                $.ajax({
                    type: "POST",
                    url: "dashboard-child/parent/logout",
                    data: {
                        "_token": "YKrhpMXr10shL8BLBIxa85cZRfOPWYREszRDvMap",
                        parent_id: parentId,
                    },
                    dataType: "json",
                    success: function (data) {
                        localStorage.removeItem("parent_id");
                        if (data.status == 200) {
                            location.href = "https://lambda.in.th/dashboard";
                        } else {
                            location.reload();
                        }
                    }
                });
            }
        }

        // Open question modal
        function openQuestionModal() {
            const myModal = new bootstrap.Modal(document.getElementById("myQuestionModal"));
            myModal.show();
        }
    </script>

    <!-- Learning Journey Logic -->
    <script>
        // Initialize variables
        const fullUrl = window.location.href;
        const pathname = window.location.pathname.replace("/", "");
        const journeyId = pathname.split("/")[3];
        const subjectId = pathname.split("/")[4];
        const userId = document.querySelector('input[name="userId"]').value;
        const progressBar = document.querySelector(".skill-progress");
        const completeIcon = document.createElement("i");
        completeIcon.className = "fa-solid fa-check";
        const playIcon = document.createElement("i");
        playIcon.className = "fa-solid fa-play";
        const practiceIcon = document.createElement("i");
        practiceIcon.className = "fa-solid fa-edit";
        let practices = 0;
        let lessons = 0;

        // Create tabs container
        const tabs = document.createElement("div");
        tabs.id = "canvas-TabContent";
        tabs.classList.add("tab-content");

        // Fetch lessons data
        const getLessons = async () => {
            try {
                const request = await fetch(`${fullUrl}/get/lessons`);
                if (!request.ok) throw new Error(request.statusText);
                const response = await request.json();
                fetchLessonsData(response);
            } catch (error) {
                console.error("Error fetching lessons:", error);
            }
        };
        getLessons();

        // Process lessons data
        const fetchLessonsData = (data) => {
            console.log("All data >>> ", data);
            lessons = data.lessons.length;
            const latest = data.learning.latest || null;
            const allLatest = data.learning.all_latest ? JSON.parse(data.learning.all_latest) : null;
            console.log("All latest >>> ", allLatest);
            const latestType = data.learning.latest_type || "lesson";
            const active = { type: null, id: null };

            const posts = document.getElementById("posts");
            const contElement = document.querySelector(".count");
            contElement.querySelector(".lesson").innerHTML = data.length;

            // Render lessons and practices
            data.lessons.forEach((lesson) => {
                const entryEl = document.createElement("div");
                entryEl.className = "entry";
                entryEl.dataset.id = lesson.id;
                entryEl.dataset.type = "lesson";
                entryEl.innerHTML = `
                    <div class="entry-timeline cursor-pointer" data-href="${fullUrl}/learning">
                        <i class="fa-solid fa-play" style="font-size: 16px !important;"></i>
                        <div class="timeline-divider"></div>
                    </div>
                    <div class="entry-title title-sm p-3">
                        <a data-href="${fullUrl}/learning" class="learn-this"><p class="fw-light">${lesson.name}</p></a>
                    </div>
                `;

                if (lesson.id == latest && latestType == "lesson") {
                    active.type = "lesson";
                    active.id = lesson.id;
                    const link = entryEl.querySelector("a");
                    link.href = link.dataset.href;
                    entryEl.querySelector(".cursor-pointer").onclick = (e) => {
                        location.href = e.target.closest(".cursor-pointer").dataset.href;
                    };
                }

                posts.append(entryEl);

                // Render practices
                lesson.practices.forEach((practice) => {
                    const practiceEl = document.createElement("div");
                    practiceEl.className = "entry";
                    practiceEl.dataset.id = practice.id;
                    practiceEl.dataset.type = "practice";
                    practiceEl.innerHTML = `
                        <div class="entry-timeline cursor-pointer" data-href="${fullUrl}/learning">
                            <i class="fa-solid fa-edit" style="font-size: 16px !important;"></i>
                            <div class="timeline-divider"></div>
                        </div>
                        <div class="entry-title title-sm p-3">
                            <a data-href="${fullUrl}/learning" class="learn-this"><p class="fw-light">Practices: ${practice.name}</p></a>
                        </div>
                    `;

                    if (practice.id == latest && latestType == "practice") {
                        active.type = "practice";
                        active.id = practice.id;
                        practiceEl.querySelector(".entry-timeline").classList.add("active");
                        const link = practiceEl.querySelector("a");
                        link.href = link.dataset.href;
                        practiceEl.querySelector(".cursor-pointer").onclick = (e) => {
                            location.href = e.target.closest(".cursor-pointer").dataset.href;
                        };
                    }

                    posts.append(practiceEl);
                });

                practices += lesson.practices.length;
            });

            // Handle initial state
            if (!latest) {
                const firstLink = posts.querySelector(".learn-this");
                firstLink.href = firstLink.dataset.href;
                firstLink.closest(".entry").querySelector(".cursor-pointer").onclick = (e) => {
                    location.href = e.target.closest(".cursor-pointer").dataset.href;
                };
            }

            // Mark completed entries
            if (data.learning.finished == 1) {
                posts.querySelectorAll(".entry").forEach((el) => {
                    el.querySelector(".entry-timeline")?.classList.add("complete");
                    el.querySelector(".active")?.classList.add("complete");
                    el.querySelector(".active")?.classList.remove("active");
                    el.querySelector("i")?.classList.add("fa-check");
                    el.querySelector("i")?.classList.remove("fa-edit");
                });
            }

            document.getElementById("jumpto").href = `${fullUrl}/learning`;

            // Mark completed entries before active entry
            let lastIndex = 0;
            posts.querySelectorAll(".entry").forEach((entry, index) => {
                if (Number(entry.dataset.id) == active.id && entry.dataset.type == active.type) {
                    lastIndex = index;
                }
            });

            posts.querySelectorAll(".entry").forEach((entry, index) => {
                if (index < lastIndex) {
                    entry.querySelector(".entry-timeline").classList.add("complete");
                    entry.querySelector(".fa-play")?.classList.add("fa-check");
                    entry.querySelector(".fa-edit")?.classList.add("fa-check");
                    entry.querySelector("a").href = `${fullUrl}/learning`;
                    entry.querySelector(".cursor-pointer").onclick = (e) => {
                        location.href = e.target.closest(".cursor-pointer").dataset.href;
                    };
                }
            });

            // Handle all latest entries
            if (allLatest && lastIndex == 0) {
                posts.querySelectorAll(".entry").forEach((el, index) => {
                    if (Number(el.dataset.id) == allLatest[index]) {
                        el.querySelector(".entry-timeline").classList.add("complete");
                        el.querySelector(".fa-play")?.classList.add("fa-check");
                        el.querySelector(".fa-edit")?.classList.add("fa-check");
                        el.querySelector("a").href = `${fullUrl}/learning`;
                        el.querySelector(".cursor-pointer").onclick = (e) => {
                            location.href = e.target.closest(".cursor-pointer").dataset.href;
                        };
                    }
                });

                const completedCount = posts.querySelectorAll(".complete").length;
                const lastEl = posts.querySelectorAll(".entry")[completedCount];
                lastEl.querySelector(".entry-timeline").classList.add("active");
                lastEl.querySelector(".fa-edit")?.classList.add("fa-play");
                lastEl.querySelector(".fa-edit")?.classList.remove("fa-edit");
                lastEl.querySelector("a").href = `${fullUrl}/learning`;
            }

            // Update counts and progress
            contElement.querySelector(".practice").innerHTML = practices;
            contElement.querySelector(".lesson").innerHTML = data.lessons.length;

            const completeCount = document.querySelectorAll(".complete").length;
            const percent = Math.round(completeCount * 100 / (lessons + practices));
            progressBar.dataset.percent = percent;
            progressBar.querySelector(".skill-progress-percent").style.width = `${percent}%`;
        };

        // Handle button clicks
        document.addEventListener("click", (e) => {
            const backBtn = e.target.closest("#back");
            if (backBtn) {
                window.location.replace("/dashboard-child/journey");
            }

            const resetBtn = e.target.closest("#reset");
            if (resetBtn && confirm("Confirm learning reset")) {
                learningReset().then(res => {
                    if (res.status != 200) {
                        alert(`${res.status} ${res.statusText}`);
                    } else {
                        location.reload();
                    }
                });
            }
        });

        // Reset learning progress
        const learningReset = async () => {
            try {
                const request = await fetch(`${window.location.href}/reset`);
                if (!request.ok) return request;
                return await request.json();
            } catch (error) {
                console.error("Error resetting learning:", error);
                return { status: 500, statusText: error.message };
            }
        };
    </script>
</body>
</html>